<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>SmallRye Reactive Messaging</title>
    <meta name="generator" content="Antora 2.3.0-beta.1">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">SmallRye Reactive Messaging</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Project</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://github.com/smallrye/smallrye-reactive-messaging">Source Code</a>
            <a class="navbar-item" href="https://github.com/smallrye/smallrye-reactive-messaging/issues">Issue Tracker</a>
          </div>
        </div>
        <a class="navbar-item" href="https://smallrye.io/" alt=>A SmallRye.io Project</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="smallrye-reactive-messaging" data-version="2.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">SmallRye Reactive Messaging</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../getting-started.html">Getting Started</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../concepts.html">Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html#messages">Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html#channels">Channels</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../concepts.html#connectors">Connectors</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../model/model.html">Development Model</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#overview">Incoming and Outgoing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#messages">Creating Messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#generating-messages">Generating messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#generating-payloads">Generating payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#consuming-messages">Consuming messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#consuming-payloads">Consuming payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#processing-messages">Processing messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#processing-payloads">Processing payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#processing-streams">Processing streams</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../model/model.html#skipping">Skipping messages or payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../acknowledgement/acknowledgement.html">Acknowledgement</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/broadcast.html">Broadcasting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/merge.html">Merging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/incomings.html">Multiple @Incoming</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/blocking.html">Handling blocking execution</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../signatures/signatures.html">Method signatures</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../connectors/connectors.html">Connectors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="kafka.html">Apache Kafka</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kafka.html#kafka-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kafka.html#kafka-inbound">Receiving Kafka Records</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="kafka.html#kafka-outbound">Writing Kafka Records</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../amqp/amqp.html">AMQP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-inbound">Receiving AMQP Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-outbound">Sending AMQP Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../amqp/amqp.html#amqp-customization">Configuring the client</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../camel/camel.html">Apache Camel</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../camel/camel.html#camel-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../camel/camel.html#camel-inbound">Receiving data using Camel</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../camel/camel.html#camel-outbound">Sending data using Camel</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../camel/camel.html#camel-api">Using existing routes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../jms/jms.html">JMS</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jms/jms.html#jms-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jms/jms.html#jms-inbound">Receiving JMS Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jms/jms.html#jms-outbound">Sending JMS Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../jms/jms.html#jms-configuration">Advanced configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../mqtt/mqtt.html">MQTT</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../mqtt/mqtt.html#mqtt-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../mqtt/mqtt.html#mqtt-inbound">Receiving MQTT Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../mqtt/mqtt.html#mqtt-outbound">Sending MQTT Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../mqtt-server/mqtt-server.html">Exposing an MQTT server</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../http/http.html">HTTP</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../http/http.html#http-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../http/http.html#http-outbound">Sending HTTP request</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../vertx-event-bus/vertx-event-bus.html">Vert.x Event Bus</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vertx-event-bus/vertx-event-bus.html#vertx-event-bus-installation">Using the connector</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vertx-event-bus/vertx-event-bus.html#vertx-event-bus-inbound">Event Bus Messages</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../vertx-event-bus/vertx-event-bus.html#vertx-event-bus-outbound">Sending Event Bus Messages</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../emitter/emitter.html">Emitters and Channels</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../emitter/emitter.html#emitter-payloads">Sending payloads</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../emitter/emitter.html#emitter-messages">Sending messages</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../emitter/emitter.html#emitter-overflow">Managing overflow</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../emitter/emitter.html#streams">Injecting channels</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../testing/testing.html">Testing applications</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../advanced/advanced.html">Advanced topics</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/advanced.html#logging">Logging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../advanced/advanced.html#strict">Strict mode</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<!-- This is the default navigation panel in the bottom left corner. We aren't using it, but let's keep it commented out
    should we change our minds about it -->
<!--
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">SmallRye Reactive Messaging</span>
    <span class="version">2.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">SmallRye Reactive Messaging</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">2.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
-->
    </div>
  </aside>
</div>
<main>
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
  <div class="edit-this-page"><a href="">Edit this Page</a></div>
</div>
<article class="doc">
<div class="sect1">
<h2 id="kafka-inbound"><a class="anchor" href="#kafka-inbound"></a>Receiving Kafka Records</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The Kafka Connector retrieves Kafka Records from Kafka Brokers and maps each of them to Reactive Messaging <code>Messages</code>.</p>
</div>
<div class="sect2">
<h3 id="_example"><a class="anchor" href="#_example"></a>Example</h3>
<div class="paragraph">
<p>Let&#8217;s imagine you have a Kafka broker running, and accessible using the <code>kafka:9092</code> address (by default it would use <code>localhost:9092</code>).
Configure your application to receive Kafka records from a Kafka <em>topic</em> on the <code>prices</code> channel as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code>kafka.bootstrap.servers=kafka:9092      <i class="conum" data-value="1"></i><b>(1)</b>

mp.messaging.incoming.prices.connector=smallrye-kafka       <i class="conum" data-value="2"></i><b>(2)</b>
mp.messaging.incoming.prices.value.deserializer=org.apache.kafka.common.serialization.DoubleDeserializer    <i class="conum" data-value="3"></i><b>(3)</b>
mp.messaging.incoming.prices.broadcast=true     <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Configure the broker location. You can configure it globally or per channel</p>
</li>
<li>
<p>Configure the connector to manage the <code>prices</code> channel</p>
</li>
<li>
<p>Sets the (Kafka) deserializer to read the record&#8217;s value</p>
</li>
<li>
<p>Make sure that we can receive from more that one consumer (see <code>KafkaPriceConsumer</code> and <code>KafkaPriceMessageConsumer</code> below)</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
You don&#8217;t need to set the Kafka topic. By default, it uses the channel name (<code>prices</code>). You can configure the <code>topic</code> attribute to override it.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Then, your application receives <code>Message&lt;Double&gt;</code>.
You can consumes the payload directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package inbound;

import org.eclipse.microprofile.reactive.messaging.Incoming;

import javax.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class KafkaPriceConsumer {

    @Incoming("prices")
    public void consume(double price) {
        // process your price.
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or, you can retrieve the <code>Message&lt;Double&gt;</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package inbound;

import org.eclipse.microprofile.reactive.messaging.Incoming;
import org.eclipse.microprofile.reactive.messaging.Message;

import javax.enterprise.context.ApplicationScoped;
import java.util.concurrent.CompletionStage;

@ApplicationScoped
public class KafkaPriceMessageConsumer {

    @Incoming("prices")
    public CompletionStage&lt;Void&gt; consume(Message&lt;Double&gt; price) {
        // process your price.

        // Acknowledge the incoming message (commit the offset)
        return price.ack();
    }

}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_deserialization"><a class="anchor" href="#_deserialization"></a>Deserialization</h3>
<div class="paragraph">
<p>The deserialization is handled by the underlying Kafka Client.
You need to configure the:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mp.messaging.incoming.[channel-name].value.deserializer</code> to configure the value deserializer (mandatory)</p>
</li>
<li>
<p><code>mp.messaging.incoming.[channel-name].key.deserializer</code> to configure the key deserializer (optional, default to <code>String</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you want to use a custom deserializer, add it to your <code>CLASSPATH</code> and configure the associate attribute.</p>
</div>
</div>
<div class="sect2">
<h3 id="_inbound_metadata"><a class="anchor" href="#_inbound_metadata"></a>Inbound Metadata</h3>
<div class="paragraph">
<p>Messages coming from Kafka contains an instance of <a href="https://smallrye.io/smallrye-reactive-messaging/2.1.1/apidocs/io/smallrye/reactive/messaging/kafka/IncomingKafkaRecordMetadata.html">IncomingKafkaRecordMetadata&lt;K, T&gt;</a> in the metadata.
<code>K</code> is the type of the record&#8217;s key.
<code>T</code> is the type of the record&#8217;s value.
It provides the key, topic, partitions, headers and so on:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">        Optional&lt;IncomingKafkaRecordMetadata&lt;String, Double&gt;&gt; metadata = incoming.getMetadata(IncomingKafkaRecordMetadata.class);
        metadata.ifPresent(meta -&gt; {
            // The topic
            String topic = meta.getTopic();

            // The key
            String key = meta.getKey();

            // The timestamp
            Instant timestamp = meta.getTimestamp();

            // The underlying record
            KafkaConsumerRecord&lt;String, Double&gt; record = meta.getRecord();

            // ...
        });</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_acknowledgement"><a class="anchor" href="#_acknowledgement"></a>Acknowledgement</h3>
<div class="paragraph">
<p>Acknowledging a message coming from Kafka commit the offset.
Refer to the Kafka documentation for details.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
To let the connector handles the offset commit, you must set the <code>enable.auto.commit</code> attribute to <code>false</code>.
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_failure_management"><a class="anchor" href="#_failure_management"></a>Failure Management</h3>
<div class="paragraph">
<p>If a message produced from a Kafka record is <em>nacked</em>, a failure strategy is applied.
The Kafka connector supports 3 strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>fail</code> - fail the application, no more records will be processed. (default)
The offset of the record that has not been processed correctly is not committed.</p>
</li>
<li>
<p><code>ignore</code> - the failure is logged, but the processing continue.
The offset of the record that has not been processed correctly is committed.</p>
</li>
<li>
<p><code>dead-letter-queue</code> - the offset of the record that has not been processed correctly is committed, but the record is written to a (Kafka) <em>dead letter topic</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The strategy is selected using the <code>failure-strategy</code> attribute.</p>
</div>
<div class="paragraph">
<p>In the case of <code>dead-letter-queue</code>, you can configure the following attributes:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>dead-letter-queue.topic</code>: the topic to use to write the records not processed correctly, default is <code>dead-letter-topic-$channel</code>, with <code>$channel</code> being the name of the channel.</p>
</li>
<li>
<p><code>dead-letter-queue.key.serializer</code>: the serializer used to write the record key on the dead letter queue. By default, it deduces the serializer from the key deserializer.</p>
</li>
<li>
<p><code>dead-letter-queue.value.serializer</code>: the serializer used to write the record value on the dead letter queue. By default, it deduces the serializer from the value deserializer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The record written on the dead letter queue contains the <code>dead-letter-reason</code> header with the nack reason (message from the exception passed to the <code>nack</code> method).
It may also contain the <code>dead-letter-cause</code> with the message from the cause, if any.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuration_reference"><a class="anchor" href="#_configuration_reference"></a>Configuration Reference</h3>
<table class="tableblock frame-all grid-all stretch">
<caption class="title">Table 1. Incoming Attributes of the 'smallrye-kafka' connector</caption>
<colgroup>
<col style="width: 27.7777%;">
<col style="width: 33.3333%;">
<col style="width: 16.6666%;">
<col style="width: 22.2224%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Attribute (<em>alias</em>)</th>
<th class="tableblock halign-left valign-top">Description</th>
<th class="tableblock halign-left valign-top">Mandatory</th>
<th class="tableblock halign-left valign-top">Default</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>bootstrap.servers</strong></p>
<p class="tableblock"><em>(kafka.bootstrap.servers)</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A comma-separated list of host:port to use for establishing the initial connection to the Kafka cluster.</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>localhost:9092</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>topic</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The consumed / populated Kafka topic. If not set, the channel name is used</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>key.deserializer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The deserializer classname used to deserialize the record&#8217;s key</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>org.apache.kafka.common.serialization.StringDeserializer</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>value.deserializer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The deserializer classname used to deserialize the record&#8217;s value</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">true</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>fetch.min.bytes</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The minimum amount of data the server should return for a fetch request. The default setting of 1 byte means that fetch requests are answered as soon as a single byte of data is available or the fetch request times out waiting for data to arrive.</p>
<p class="tableblock">Type: <em>int</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>group.id</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A unique string that identifies the consumer group the application belongs to. If not set, a unique, generated id is used</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>retry</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether or not the connection to the broker is re-attempted in case of failure</p>
<p class="tableblock">Type: <em>boolean</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>true</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>retry-attempts</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The maximum number of reconnection before failing. -1 means infinite retry</p>
<p class="tableblock">Type: <em>int</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>-1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>retry-max-wait</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The max delay (in seconds) between 2 reconnects</p>
<p class="tableblock">Type: <em>int</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>30</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>broadcast</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the Kafka records should be dispatched to multiple consumer</p>
<p class="tableblock">Type: <em>boolean</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>false</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>auto.offset.reset</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">What to do when there is no initial offset in Kafka.Accepted values are earliest, latest and none</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>latest</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>failure-strategy</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Specify the failure strategy to apply when a message produced from a record is nacked. Values can be <code>fail</code> (default), <code>ignore</code>, or <code>dead-letter-queue</code></p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>fail</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>dead-letter-queue.topic</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates on which topic the record is sent. Defaults is <code>dead-letter-topic-$channel</code></p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>dead-letter-queue.key.serializer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates the key serializer to use. If not set the serializer associated to the key deserializer is used</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>dead-letter-queue.value.serializer</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">When the <code>failure-strategy</code> is set to <code>dead-letter-queue</code> indicates the value serializer to use. If not set the serializer associated to the value deserializer is used</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>partitions</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The number of partitions to be consumed concurrently. The connector creates the specified amount of Kafka consumers. It should match the number of partition of the targetted topic</p>
<p class="tableblock">Type: <em>int</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>1</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>consumer-rebalance-listener.name</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name set in <code>javax.inject.Named</code> of a bean that implements <code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code>. If set the listener will be applied to the consumer.</p>
<p class="tableblock">Type: <em>string</em></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">false</p></td>
<td class="tableblock halign-left valign-top"></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You can also pass any property supported by the <a href="https://vertx.io/docs/vertx-kafka-client/java/">Vert.x Kafka client</a> as attribute.</p>
</div>
</div>
<div class="sect2">
<h3 id="kafka-consumer-rebalance-listener"><a class="anchor" href="#kafka-consumer-rebalance-listener"></a>Consumer Rebalance Listener</h3>
<div class="paragraph">
<p>An implementation of the consumer re-balance listener can be provided which affords us fine grain controls of the assigned
offset. Common uses are storing offsets in a separate store to enable deliver exactly-once semantics, and starting from
a specific time window.</p>
</div>
<div class="paragraph">
<p>Whenever the topic partitions assigned method is called the consumer will pause. It will only resume once the returned
Uni succeeds. In the case of failure it will retry until success or until the consumer session times out in which case
it will resume again forcing a new consumer re-balance.</p>
</div>
<div class="sect3">
<h4 id="_example_2"><a class="anchor" href="#_example_2"></a>Example</h4>
<div class="paragraph">
<p>In this example we will set-up a consumer that always starts on messages from at most 10 minutes ago. First we need to provide
a bean managed implementation of <code>io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener</code> annotated with
<code>javax.inject.Named</code>. We then must configure our inbound connector to use this named bean.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package inbound;

import io.smallrye.mutiny.Uni;
import io.smallrye.reactive.messaging.kafka.KafkaConsumerRebalanceListener;
import io.vertx.kafka.client.common.TopicPartition;
import io.vertx.mutiny.kafka.client.consumer.KafkaConsumer;

import javax.enterprise.context.ApplicationScoped;
import javax.inject.Named;
import java.util.Set;
import java.util.logging.Logger;
import java.util.stream.Collectors;

@ApplicationScoped
@Named("rebalanced-example.rebalancer")
public class KafkaRebalancedConsumerRebalanceListener implements KafkaConsumerRebalanceListener {

    private static final Logger LOGGER = Logger.getLogger(KafkaRebalancedConsumerRebalanceListener.class.getName());

    /**
     * When receiving a list of partitions will search for the earliest offset within 10 minutes
     * and seek the consumer to it.
     *
     * @param consumer        underlying consumer
     * @param topicPartitions set of assigned topic partitions
     * @return A {@link Uni} indicating operations complete or failure
     */
    @Override
    public Uni&lt;Void&gt; onPartitionsAssigned(KafkaConsumer&lt;?, ?&gt; consumer, Set&lt;TopicPartition&gt; topicPartitions) {
        long now = System.currentTimeMillis();
        long shouldStartAt = now - 600_000L; //10 minute ago

        return Uni
            .combine()
            .all()
            .unis(topicPartitions
                .stream()
                .map(topicPartition -&gt; {
                    LOGGER.info("Assigned " + topicPartition);
                    return consumer.offsetsForTimes(topicPartition, shouldStartAt)
                        .onItem()
                        .invoke(o -&gt; LOGGER.info("Seeking to " + o))
                        .onItem()
                        .produceUni(o -&gt; consumer
                            .seek(topicPartition, o == null ? 0L : o.getOffset())
                            .onItem()
                            .invoke(v -&gt; LOGGER.info("Seeked to " + o))
                        );
                })
                .collect(Collectors.toList()))
            .combinedWith(a -&gt; null);
    }

    @Override
    public Uni&lt;Void&gt; onPartitionsRevoked(KafkaConsumer&lt;?, ?&gt; consumer, Set&lt;TopicPartition&gt; topicPartitions) {
        return Uni
            .createFrom()
            .nullItem();
    }
}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package inbound;

import io.smallrye.reactive.messaging.kafka.IncomingKafkaRecord;
import org.eclipse.microprofile.reactive.messaging.Acknowledgment;
import org.eclipse.microprofile.reactive.messaging.Incoming;

import javax.enterprise.context.ApplicationScoped;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;

@ApplicationScoped
public class KafkaRebalancedConsumer {

    @Incoming("rebalanced-example")
    @Acknowledgment(Acknowledgment.Strategy.NONE)
    public CompletionStage&lt;Void&gt; consume(IncomingKafkaRecord&lt;Integer, String&gt; message) {
        // We don't need to ACK messages because in this example we set offset during consumer re-balance
        return CompletableFuture.completedFuture(null);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>To configure the inbound connector to use the provided listener we either set the consumer rebalance listener&#8217;s name:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mp.messaging.incoming.rebalanced-example.consumer-rebalance-listener.name=rebalanced-example.rebalancer</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Or have the listener&#8217;s name be the same as the group id:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>mp.messaging.incoming.rebalanced-example.group.id=rebalanced-example.rebalancer</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Setting the consumer re-balance listener&#8217;s name takes precedence over using the group id.</p>
</div>
</div>
</div>
</div>
</div>
</article>
</main>
</div>
<footer class="footer">
  <p>SmallRye Reactive Messaging is licensed until the terms of the Apache Software License 2.0</p>
  <p>Access the source code from the <a href="https://github.com/smallrye/smallrye-reactive-messaging">GitHub repository</a>.</p>
</footer>
<script src="../../../_/js/site.js"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
